<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f6f7fb; }
    .card-kpi { border: 0; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .table-wrap { border-radius: 16px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .small-muted { color: #6c757d; font-size: .85rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: .9rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">Sky Assistant Admin</h3>
        <div class="small-muted">Sessions, leads & chats (UTC timestamps)</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-primary" href="/admin/export.csv?{{ base_qs }}">Export CSV</a>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <div class="card card-kpi p-3">
          <div class="small-muted">Total Sessions</div>
          <div class="fs-3 fw-bold">{{ kpis.total_sessions }}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card card-kpi p-3">
          <div class="small-muted">Today Sessions</div>
          <div class="fs-3 fw-bold">{{ kpis.today_sessions }}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card card-kpi p-3">
          <div class="small-muted">Total Messages</div>
          <div class="fs-3 fw-bold">{{ kpis.total_messages }}</div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card card-kpi p-3 mb-3">
      <form class="row g-2 align-items-end" method="get" action="/admin/dashboard">
        <div class="col-md-4">
          <label class="form-label small-muted">Search (name/phone/page/session)</label>
          <input class="form-control" name="q" value="{{ filters.q }}" placeholder="e.g. 03xx, Ali, /booking">
        </div>
        <div class="col-md-3">
          <label class="form-label small-muted">Page contains</label>
          <input class="form-control" name="page" value="{{ filters.page }}" placeholder="/some-page">
        </div>
        <div class="col-md-2">
          <label class="form-label small-muted">From</label>
          <input class="form-control" type="date" name="from" value="{{ filters.from }}">
        </div>
        <div class="col-md-2">
          <label class="form-label small-muted">To</label>
          <input class="form-control" type="date" name="to" value="{{ filters.to }}">
        </div>
        <div class="col-md-1">
          <label class="form-label small-muted">Per</label>
          <select class="form-select" name="per">
            {% for n in [25,50,100] %}
              <option value="{{n}}" {% if filters.per == n %}selected{% endif %}>{{n}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-primary">Apply</button>
          <a class="btn btn-outline-secondary" href="/admin/dashboard">Reset</a>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="table-wrap bg-white">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Created (UTC)</th>
            <th>Lead</th>
            <th>Phone</th>
            <th>Page</th>
            <th>Session</th>
            <th>Last message</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for s in sessions %}
            {% set last = last_msgs_map.get(s.session_id) %}
            <tr>
              <td class="small-muted">{{ s.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
              <td>{{ s.name or "-" }}</td>
              <td class="mono">{{ s.phone or "-" }}</td>
              <td class="small-muted" style="max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                {{ s.page or "-" }}
              </td>
              <td class="mono" style="max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                {{ s.session_id }}
              </td>
              <td style="max-width:320px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                {{ (last.content if last else "-") }}
              </td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-primary" href="/admin/session/{{ s.session_id }}">View</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="small-muted">
        Showing {{ pagination.items|length }} of {{ pagination.total }} results
      </div>
      <nav>
        <ul class="pagination mb-0">
          {% if pagination.has_prev %}
            <li class="page-item">
              <a class="page-link" href="/admin/dashboard?p={{ pagination.prev_num }}{% if base_qs %}&{{ base_qs }}{% endif %}">Prev</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Prev</span></li>
          {% endif %}

          <li class="page-item disabled"><span class="page-link">Page {{ pagination.page }} / {{ pagination.pages }}</span></li>

          {% if pagination.has_next %}
            <li class="page-item">
              <a class="page-link" href="/admin/dashboard?p={{ pagination.next_num }}{% if base_qs %}&{{ base_qs }}{% endif %}">Next</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</body>
</html>
